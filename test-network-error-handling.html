<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test de Gestion d'Erreurs Réseau</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body {
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        .status-online {
            background-color: #d4edda;
            color: #155724;
        }
        .status-offline {
            background-color: #f8d7da;
            color: #721c24;
        }
        .log-container {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .log-entry {
            margin-bottom: 5px;
            padding: 4px 8px;
            border-left: 3px solid #6c757d;
        }
        .log-info { border-left-color: #0dcaf0; }
        .log-success { border-left-color: #198754; }
        .log-error { border-left-color: #dc3545; }
        .log-warning { border-left-color: #ffc107; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1 class="mb-4">
            <i class="bi bi-wifi"></i> Test de Gestion d'Erreurs Réseau
            <span id="networkStatus" class="status-badge status-online">En ligne</span>
        </h1>
        
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i>
            <strong>Instructions:</strong> Cette page vous permet de tester la gestion des erreurs réseau et la logique de retry automatique.
            Vous pouvez simuler différentes conditions d'erreur pour voir comment le système réagit.
        </div>

        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-gear"></i> Configuration
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Nombre de tentatives maximum:</label>
                            <input type="number" id="maxRetries" class="form-control" value="3" min="0" max="10">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Délai de retry (ms):</label>
                            <input type="number" id="retryDelay" class="form-control" value="1000" min="100" max="10000" step="100">
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input type="checkbox" id="exponentialBackoff" class="form-check-input" checked>
                                <label class="form-check-label" for="exponentialBackoff">
                                    Backoff exponentiel
                                </label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Timeout (ms):</label>
                            <input type="number" id="timeout" class="form-control" value="5000" min="1000" max="60000" step="1000">
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-bug"></i> Tests
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary w-100 mb-2" onclick="testNormalCall()">
                            <i class="bi bi-check-circle"></i> Appel API Normal
                        </button>
                        <button class="btn btn-warning w-100 mb-2" onclick="testInvalidEndpoint()">
                            <i class="bi bi-exclamation-triangle"></i> Point de terminaison invalide (404)
                        </button>
                        <button class="btn btn-danger w-100 mb-2" onclick="testNetworkError()">
                            <i class="bi bi-wifi-off"></i> Simuler erreur réseau
                        </button>
                        <button class="btn btn-secondary w-100 mb-2" onclick="testTimeout()">
                            <i class="bi bi-clock"></i> Simuler timeout
                        </button>
                        <button class="btn btn-info w-100 mb-2" onclick="testWithCustomRetry()">
                            <i class="bi bi-arrow-repeat"></i> Test avec retry personnalisé
                        </button>
                        <button class="btn btn-outline-danger w-100 mt-3" onclick="clearLog()">
                            <i class="bi bi-trash"></i> Effacer les logs
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <i class="bi bi-file-text"></i> Journal des événements
            </div>
            <div class="card-body">
                <div id="logContainer" class="log-container">
                    <div class="log-entry log-info">Prêt à tester...</div>
                </div>
            </div>
        </div>
    </div>

    <script src="/assets/js/api.js"></script>
    <script>
        // Mettre à jour l'indicateur de statut réseau
        function updateNetworkStatus(isOnline) {
            const badge = document.getElementById('networkStatus');
            if (isOnline) {
                badge.textContent = 'En ligne';
                badge.className = 'status-badge status-online';
            } else {
                badge.textContent = 'Hors ligne';
                badge.className = 'status-badge status-offline';
            }
            addLog('info', `État réseau: ${isOnline ? 'En ligne' : 'Hors ligne'}`);
        }

        // Écouter les changements de connexion réseau
        window.NetworkState.addListener(updateNetworkStatus);

        // Fonction pour ajouter une entrée au journal
        function addLog(type, message) {
            const logContainer = document.getElementById('logContainer');
            const entry = document.createElement('div');
            const timestamp = new Date().toLocaleTimeString('fr-FR');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // Effacer le journal
        function clearLog() {
            document.getElementById('logContainer').innerHTML = '<div class="log-entry log-info">Journal effacé...</div>';
        }

        // Obtenir la configuration actuelle
        function getConfig() {
            return {
                maxRetries: parseInt(document.getElementById('maxRetries').value),
                retryDelay: parseInt(document.getElementById('retryDelay').value),
                exponentialBackoff: document.getElementById('exponentialBackoff').checked,
                timeout: parseInt(document.getElementById('timeout').value)
            };
        }

        // Test d'un appel API normal
        async function testNormalCall() {
            addLog('info', 'Test: Appel API normal...');
            const config = getConfig();
            
            try {
                const result = await apiCall('/products?page=1&limit=5', 'GET', null, config);
                
                if (result.success) {
                    addLog('success', `✓ Appel réussi - Status: ${result.status}`);
                    addLog('info', `Données reçues: ${JSON.stringify(result.data).substring(0, 100)}...`);
                } else {
                    addLog('error', `✗ Échec - Status: ${result.status}, Erreur: ${result.error || 'Inconnue'}`);
                }
            } catch (error) {
                addLog('error', `✗ Exception: ${error.message}`);
            }
        }

        // Test avec point de terminaison invalide
        async function testInvalidEndpoint() {
            addLog('info', 'Test: Point de terminaison invalide (404)...');
            const config = getConfig();
            
            try {
                const result = await apiCall('/invalid-endpoint-12345', 'GET', null, config);
                
                if (result.success) {
                    addLog('success', `✓ Appel réussi (inattendu) - Status: ${result.status}`);
                } else {
                    addLog('warning', `Échec attendu - Status: ${result.status}`);
                    if (result.data && result.data.message) {
                        addLog('info', `Message: ${result.data.message}`);
                    }
                }
            } catch (error) {
                addLog('error', `✗ Exception: ${error.message}`);
            }
        }

        // Simuler une erreur réseau (en utilisant un domaine invalide)
        async function testNetworkError() {
            addLog('info', 'Test: Simulation d\'erreur réseau...');
            const config = getConfig();
            
            // Temporairement changer l'URL de base
            const originalBaseUrl = API_CONFIG.baseUrl;
            API_CONFIG.baseUrl = 'http://invalid-domain-that-does-not-exist-12345.com';
            
            try {
                const result = await apiCall('/products', 'GET', null, config);
                
                if (result.success) {
                    addLog('success', `✓ Appel réussi (inattendu)`);
                } else {
                    addLog('error', `✗ Erreur réseau détectée - Type: ${result.errorType || 'network'}`);
                    addLog('info', `Message: ${result.error}`);
                    addLog('info', `Retriable: ${isRetriableError(result) ? 'Oui' : 'Non'}`);
                }
            } catch (error) {
                addLog('error', `✗ Exception: ${error.message}`);
            } finally {
                // Restaurer l'URL de base
                API_CONFIG.baseUrl = originalBaseUrl;
            }
        }

        // Simuler un timeout
        async function testTimeout() {
            addLog('info', 'Test: Simulation de timeout...');
            
            // Utiliser un timeout très court pour forcer l'erreur
            const config = {
                ...getConfig(),
                timeout: 1 // 1ms - forcera un timeout
            };
            
            try {
                const result = await apiCall('/products', 'GET', null, config);
                
                if (result.success) {
                    addLog('success', `✓ Appel réussi (inattendu)`);
                } else {
                    addLog('error', `✗ Timeout détecté - Type: ${result.errorType}`);
                    addLog('info', `Message: ${result.error}`);
                    addLog('info', `Retriable: ${isRetriableError(result) ? 'Oui' : 'Non'}`);
                }
            } catch (error) {
                addLog('error', `✗ Exception: ${error.message}`);
            }
        }

        // Test avec configuration de retry personnalisée
        async function testWithCustomRetry() {
            addLog('info', 'Test: Retry avec configuration personnalisée...');
            
            const config = {
                maxRetries: 5,
                retryDelay: 500,
                exponentialBackoff: true,
                timeout: 1 // Forcer timeout pour tester retry
            };
            
            addLog('info', `Config: ${config.maxRetries} tentatives, délai ${config.retryDelay}ms, backoff exponentiel`);
            
            try {
                const result = await apiCall('/products', 'GET', null, config);
                
                if (result.success) {
                    addLog('success', `✓ Appel réussi après retry`);
                } else {
                    addLog('error', `✗ Échec après toutes les tentatives`);
                    addLog('info', `Type d'erreur: ${result.errorType}`);
                }
            } catch (error) {
                addLog('error', `✗ Exception: ${error.message}`);
            }
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            addLog('success', 'Page chargée - Système de gestion d\'erreurs initialisé');
            addLog('info', `Configuration par défaut: ${API_CONFIG.maxRetries} tentatives, ${API_CONFIG.retryDelay}ms de délai`);
            updateNetworkStatus(window.NetworkState.isOnline);
        });
    </script>
</body>
</html>
